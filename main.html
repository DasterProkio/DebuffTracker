<!DOCTYPE html>
<html lang="zh-CN" class="font-sans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航·序AI (Demo)</title> <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

<style id="default-styles">
    /* Define CSS Variables */
    :root {
        --bg-start: #2b1a3d; /* Deep Purple */
        --bg-mid: #1f3a61; /* Deep Blue */
        --bg-end: #1a4a5a; /* Dark Cyan/Teal */
        --text-primary: #f0f0f8; /* Light Lavender/White */
        --text-secondary: #a0a0c0; /* Muted Lavender */
        --accent-start: #8a4fff; /* Vibrant Purple */
        --accent-mid: #3b82f6; /* Blue 500 */
        --accent-end: #14b8a6; /* Teal 500 */
        --glass-bg: rgba(255, 255, 255, 0.05);
        --glass-border: rgba(255, 255, 255, 0.1);
        --shadow-color: rgba(0, 0, 0, 0.3);
        --shadow-light: rgba(255, 255, 255, 0.1); /* Subtle highlight */
    }

    /* Base Body Style with Animated Gradient */
    body {
        font-family: 'Noto Sans SC', sans-serif;
        color: var(--text-primary);
        background: linear-gradient(270deg, var(--bg-start), var(--bg-mid), var(--bg-end), var(--bg-mid), var(--bg-start));
        background-size: 600% 600%;
        animation: flowingGradient 25s ease infinite;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        opacity: 0; /* Start hidden for fade-in */
        animation: fadeInAnimation ease 0.6s forwards;
        animation-delay: 0.1s;
    }

    @keyframes flowingGradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
     @keyframes fadeInAnimation {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
    }


    /* Container */
    .liquid-container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 1.5rem; /* Less padding initially, components have own */
    }

    /* Headings */
    h1, h2, h3, h4, h5, h6 {
        color: var(--text-primary);
        font-weight: 500; /* Medium */
        text-shadow: 0 1px 3px var(--shadow-color);
    }
    h1 {
        font-size: 2rem; /* text-3xl */
        font-weight: 700; /* Bold */
        text-align: center;
        margin-bottom: 2rem;
        /* Apply subtle gradient to text */
        background: linear-gradient(90deg, var(--accent-start), #5dade2, var(--accent-end));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    h2 {
        font-size: 1.5rem; /* text-2xl */
        font-weight: 600; /* Semibold */
        margin-bottom: 1.25rem; /* mb-5 */
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
     h2 .fas { /* Icon within H2 */
         color: var(--accent-mid);
         opacity: 0.8;
    }
    h3 { /* Section sub-headers */
        font-size: 1.125rem; /* text-lg */
        font-weight: 600;
        margin-bottom: 0.75rem; /* mb-3 */
         color: var(--text-primary);
         opacity: 0.9;
    }

    /* Sections/Cards - Glassmorphism */
    .glass-section {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 1.5rem; /* rounded-3xl */
        padding: 1.5rem; /* p-6 */
        box-shadow: 0 8px 32px 0 var(--shadow-color), inset 0 1px 0 0 var(--shadow-light);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        margin-bottom: 2rem; /* space-y-8 equivalent */
         transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .glass-section:hover {
         /* Subtle lift effect */
         /* transform: translateY(-2px); */
         /* box-shadow: 0 12px 40px 0 var(--shadow-color), inset 0 1px 0 0 var(--shadow-light); */
    }


    /* Buttons - Liquid Style */
    button, .button-like-label {
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem; /* py-2.5 px-5 */
        border-radius: 9999px; /* rounded-full */
        font-weight: 500; /* medium */
        text-align: center;
        vertical-align: middle;
        border: 1px solid transparent;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        margin: 0.3rem;
        cursor: pointer;
        position: relative; /* For potential pseudo elements */
        overflow: hidden; /* For effects */
        box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.2), inset 0 -1px 2px 0 rgba(255, 255, 255, 0.1);
    }
    /* Primary Accent Button */
    .btn-liquid-accent {
         background: linear-gradient(120deg, var(--accent-start) 0%, var(--accent-mid) 50%, var(--accent-end) 100%);
         background-size: 200% 100%; /* For potential hover animation */
         color: white;
         border-color: rgba(255, 255, 255, 0.2);
    }
    .btn-liquid-accent:hover {
         background-position: right center; /* Change gradient position */
         box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.25), inset 0 -1px 2px 0 rgba(255, 255, 255, 0.1);
         transform: translateY(-1px);
    }
     /* Secondary Button - Translucent */
    .btn-liquid-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: var(--glass-border);
        color: var(--text-primary);
         backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    .btn-liquid-secondary:hover {
         background-color: rgba(255, 255, 255, 0.15);
         border-color: rgba(255, 255, 255, 0.3);
         transform: translateY(-1px);
    }
    /* Small action buttons (edit/delete) */
    .btn-action {
         padding: 0.3rem 0.7rem;
         font-size: 0.8rem;
         border-radius: 9999px;
         box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .btn-edit { background-color: rgba(245, 158, 11, 0.6); /* amber-500 transparent */ color: white; border: none;}
    .btn-edit:hover { background-color: rgba(217, 119, 6, 0.8); /* amber-600 */ }
    .btn-delete { background-color: rgba(220, 38, 38, 0.5); /* red-600 transparent */ color: white; border: none;}
    .btn-delete:hover { background-color: rgba(185, 28, 28, 0.7); /* red-700 */ }
     .btn-remove { background-color: rgba(253, 126, 20, 0.6); /* orange-500 transparent */ color: white; border: none;}
     .btn-remove:hover { background-color: rgba(234, 88, 12, 0.8); /* orange-600 */ }


    /* Forms - Liquid Style */
    label {
         display: block;
         margin-bottom: 0.4rem;
         font-size: 0.9rem;
         font-weight: 400;
         color: var(--text-secondary);
         opacity: 0.9;
    }
    input[type="text"], input[type="number"], textarea, select {
        display: block;
        width: 100%;
        padding: 0.7rem 1rem;
        font-size: 0.95rem;
        color: var(--text-primary);
        background-color: rgba(0, 0, 0, 0.2); /* Dark transparent */
        border: 1px solid var(--glass-border);
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
         margin-top: 0.2rem;
         transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
     input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--accent-mid);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4), inset 0 2px 4px rgba(0,0,0,0.3); /* Blue ring */
     }
    input[type="number"] { width: 7rem; text-align: center;}
    select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a0a0c0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.7rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; padding-right: 2.8rem; min-width: 9rem; }
    textarea { min-height: 90px; }

    /* Lists - Liquid Style */
    ul { list-style: none; padding: 0; margin: 0; }
    #routine-list li, #potential-debuffs-list li, .manager-section li {
        padding: 0.8rem 0;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        transition: background-color 0.2s ease;
    }
     /* Add subtle hover to list items maybe? */
     /* #routine-list li:hover, .manager-section li:hover { background-color: rgba(255, 255, 255, 0.03); } */
     #routine-list li:last-child, #potential-debuffs-list li:last-child, .manager-section li:last-child { border-bottom: none; }

    .routine-info, .item-details { flex-grow: 1; margin-right: 1rem; display: flex; flex-direction: column; }
    .routine-name, .item-name { font-weight: 500; color: var(--text-primary); font-size: 1rem;}
    .last-completed, .item-frequency, .status-message { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; opacity: 0.85;}
    /* Specific style for error messages related to date */
    .last-completed.date-error { color: #fca5a5; /* Lighter red for errors */ font-style: italic; opacity: 0.9; }
    .status-message.overdue-true { color: #f87171; /* Lighter Red */ font-weight: 500; opacity: 1;}
    .status-message.overdue-soon { color: #facc15; /* Lighter Yellow */ opacity: 1;}
    .status-message.overdue-false { color: #34d399; /* Lighter Emerald */ opacity: 1;}
    button.routine-done-btn { background: linear-gradient(120deg, #34d399, #2dd4bf); color: #1f2937; /* Dark text */ padding: 0.3rem 0.7rem; font-size: 0.8rem; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    button.routine-done-btn:hover { filter: brightness(1.1); transform: scale(1.05); }
    .action-buttons { flex-shrink: 0; } /* Prevent shrinking */

    /* Modal - Liquid Style */
    .modal { display: none; /* Hidden by default */ position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
    .modal-content {
        background: radial-gradient(circle at top left, rgba(43, 26, 61, 0.85), rgba(31, 58, 97, 0.85)); /* Darker, less transparent gradient */
        margin: 10% auto; /* Centered */
        border: 1px solid var(--glass-border);
        box-shadow: 0 15px 50px 0 var(--shadow-color), inset 0 1px 0 0 var(--shadow-light);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 1.5rem; /* rounded-3xl */
        padding: 2rem; /* p-8 */
        max-width: 600px; /* Limit width */
        position: relative;
    }
    .modal-content h3 { border-bottom-color: var(--glass-border); color: var(--text-primary); opacity: 1; }
    .close-btn { position: absolute; font-size: 1.75rem; color: var(--text-secondary); top: 1rem; right: 1.2rem; opacity: 0.7; transition: opacity 0.2s ease; cursor: pointer; line-height: 1; }
    .close-btn:hover { opacity: 1; color: var(--text-primary); }

    /* Intensity Slider - Liquid */
     .slider-container { display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem;} /* Use flex */
     #debuff-intensity-slider {
         flex-grow: 1; cursor: pointer; height: 6px; border-radius: 3px;
         background: linear-gradient(90deg, var(--accent-mid) 0%, var(--accent-end) 100%);
         appearance: none; -webkit-appearance: none;
         box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
         border: 1px solid rgba(255, 255, 255, 0.1);
     }
     #debuff-intensity-slider::-webkit-slider-thumb {
         appearance: none; -webkit-appearance: none;
         width: 18px; height: 18px;
         background: var(--text-primary); /* White thumb */
         border-radius: 50%; cursor: pointer;
         border: 1px solid rgba(0,0,0,0.2);
         box-shadow: 0 2px 5px rgba(0,0,0,0.3);
         transition: transform 0.2s ease;
     }
     #debuff-intensity-slider::-moz-range-thumb {
         width: 18px; height: 18px; background: var(--text-primary); border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
     }
     #debuff-intensity-slider:active::-webkit-slider-thumb { transform: scale(1.1); }
     #intensity-value-display { font-weight: 600; color: var(--text-primary); font-size: 1rem; min-width: 20px; text-align: right; }
     .intensity-label-text { font-size: 0.8rem; color: var(--text-secondary); }

    /* Manager Section Adjustments */
     .manager-section { background: rgba(0,0,0,0.1); border-radius: 1rem; border: 1px solid var(--glass-border); padding: 1rem; }
     .manager-section h4 { color: var(--text-primary); opacity: 0.9; font-size: 1rem; margin-bottom: 0.75rem;}
     .manager-section ul { background: transparent; border: none; max-height: 200px; overflow-y: auto; margin-bottom: 1rem;}
     .manager-section li { border-bottom-color: var(--glass-border); padding: 0.6rem 0.2rem; }
     .add-item-form { border: none; background: transparent; padding: 0; }
     .add-item-form h5 { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 400;}


    /* Markdown Output Area */
    #markdown-output {
         background: rgba(0, 0, 0, 0.15);
         border: 1px solid var(--glass-border);
         border-radius: 1rem; /* rounded-2xl */
         padding: 1.5rem;
         font-size: 0.95rem;
         line-height: 1.7;
         color: var(--text-secondary);
         backdrop-filter: blur(5px);
         -webkit-backdrop-filter: blur(5px);
         min-height: 100px; /* Ensure it has some height */
    }
     #markdown-output h3 { color: var(--text-primary); font-size: 1.1rem; border-bottom-color: var(--glass-border); opacity: 0.9;}
     #markdown-output ul { list-style: none; padding-left: 0; margin-top: 0.5rem;}
     #markdown-output li { position: relative; padding-left: 1.6em; margin-bottom: 0.4rem; }
     #markdown-output li::before { content: "✦"; /* Sparkle or other organic shape */ position: absolute; left: 0; top: 0.1em; /* Adjust vertical alignment */ margin-right: 0.6em; color: var(--accent-end); opacity: 0.7; }
     #markdown-output strong { font-weight: 600; color: var(--text-primary); opacity: 0.95; }
     #markdown-output p { margin-bottom: 0.5rem; }

    /* Utility for slight 3D lift */
    .lift-element {
         transition: transform 0.3s ease, box-shadow 0.3s ease;
     }
     .lift-element:hover {
         transform: perspective(500px) translateZ(5px);
         box-shadow: 0 5px 15px var(--shadow-color);
     }

    /* Status spans */
    #import-status, #css-import-status { display: inline-block; margin-left: 1rem; font-size: 0.85em; opacity: 0.8; }
    #import-status.success, #css-import-status.success { color: #34d399; }
    #import-status.error, #css-import-status.error { color: #f87171; }

    /* Ensure icons align well with text */
    .fas, .far, .fal, .fad, .fab { margin-right: 0.4em; vertical-align: -0.1em; }

    /* Responsive */
    @media (max-width: 768px) {
         body { background-size: 800% 800%; } /* Slow down animation slightly on mobile maybe */
         .liquid-container { padding: 1rem; margin: 1rem auto;}
         h1 { font-size: 1.75rem; } h2 { font-size: 1.25rem; }
         .glass-section { padding: 1rem; border-radius: 1rem; }
         button, .button-like-label { padding: 0.5rem 1rem; font-size: 0.85rem; }
         .modal-content { padding: 1.5rem; border-radius: 1rem; margin: 5% auto; max-width: 90%; } /* Adjust modal on mobile */
    }

</style>
</head>
<body class="min-h-screen">
    <div class="liquid-container">
        <header>
            <h1>航·序AI</h1> </header>

<main class="space-y-8">
        <section class="logging-area glass-section">
            <h2><i class="fas fa-plus-circle"></i>记录状态 (Debuff)</h2> <div id="l1-categories-display" class="mt-4 flex flex-wrap gap-3">
                <p class="text-sm text-gray-400">加载分类中...</p>
            </div>
        </section>

        <div id="debuff-logger" class="modal">
             <div class="modal-content">
                <span class="close-btn" onclick="closeModal('debuff-logger')">×</span>
                <h3 id="debuff-modal-title" class="text-xl font-semibold mb-6">记录状态 (Debuff)</h3> <div id="category2-options" class="mb-6">
                    <h4 class="text-base font-medium mb-3 text-gray-300">选择二级分类 (<span id="selected-cat1-display" class="font-semibold text-gray-100"></span>):</h4>
                    <div id="category2-buttons" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="debuff-details" style="display: none;" class="space-y-5 pt-5 border-t border-[var(--glass-border)]">
                    <h4 class="text-base font-medium mb-3 text-gray-300">添加详情 (<span id="selected-cat2-display" class="font-semibold text-gray-100"></span>):</h4>
                    <div>
                        <label for="debuff-duration">持续时间:</label>
                        <input type="text" id="debuff-duration" placeholder="例如: 几小时, 半天, 持续中">
                    </div>
                    <div class="intensity-container">
                        <label for="debuff-intensity-slider">强度:</label>
                        <div class="slider-container">
                            <span class="intensity-label-text">1</span>
                            <input type="range" id="debuff-intensity-slider" min="1" max="5" value="3">
                            <span class="intensity-label-text">5</span>
                            <span id="intensity-value-display" class="ml-2">3</span>
                        </div>
                    </div>
                    <div>
                        <label for="debuff-notes">备注:</label>
                        <textarea id="debuff-notes" rows="3" placeholder="可选：触发因素？缓解方式？"></textarea> </div>
                    <div class="flex justify-start gap-4 pt-4">
                         <button id="submit-debuff-btn" class="btn-liquid-accent"><i class="fas fa-check"></i>确认</button>
                         <button onclick="goBackToL2()" id="debuff-back-btn" class="btn-liquid-secondary"><i class="fas fa-arrow-left"></i>返回</button>
                    </div>
                </div>
            </div>
        </div>

        <section class="dashboard grid md:grid-cols-2 gap-8">
             <div class="glass-section">
                <h2><i class="fas fa-exclamation-triangle"></i>潜在关联与建议</h2> <ul id="potential-debuffs-list" class="mt-4 space-y-3"><li>加载中...</li></ul>
             </div>
             <div class="glass-section">
                <h2><i class="fas fa-sync-alt"></i>日常作息 (Routine)</h2> <ul id="routine-list" class="mt-4"><li>加载中...</li></ul>
             </div>
         </section>

         <section class="settings-area glass-section">
             <h2><i class="fas fa-cog"></i>数据与设置</h2>
              <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                 <div class="space-y-3">
                     <h3 class="text-base font-medium">应用管理</h3>
                     <button id="manage-categories-btn" class="w-full text-left btn-liquid-secondary justify-start"><i class="fas fa-tags fa-fw"></i>管理状态分类</button> <button id="manage-routines-btn" class="w-full text-left btn-liquid-secondary justify-start"><i class="fas fa-calendar-check fa-fw"></i>管理日常作息</button> </div>
                 <div class="space-y-3">
                      <h3 class="text-base font-medium">数据操作</h3>
                      <button id="export-data-btn" class="w-full text-left btn-liquid-secondary justify-start"><i class="fas fa-file-export fa-fw"></i>导出数据 (JSON)</button> <label for="import-file-input" class="button-like-label w-full !justify-start btn-liquid-secondary"><i class="fas fa-file-import fa-fw"></i>导入数据 (JSON)</label> <input type="file" id="import-file-input" accept=".json" class="hidden">
                     <span id="import-status"></span>
                 </div>
                 <div class="space-y-3">
                     <h3 class="text-base font-medium">外观样式</h3>
                     <label for="import-css-input" class="button-like-label w-full !justify-start btn-liquid-secondary"><i class="fas fa-palette fa-fw"></i>导入样式 (CSS)</label> <input type="file" id="import-css-input" accept=".css" class="hidden">
                     <button id="remove-css-btn" class="w-full text-left btn-remove justify-start"><i class="fas fa-times-circle fa-fw"></i>移除自定义样式</button> <span id="css-import-status"></span>
                 </div>
             </div>
        </section>

        <div id="category-manager" class="modal">
              <div class="modal-content">
                <span class="close-btn" onclick="closeModal('category-manager')">×</span>
                <h3 class="text-xl font-semibold mb-6">管理状态分类</h3> <div class="manager-section space-y-4">
                    <div>
                        <h4 class="text-lg font-medium mb-2">一级分类 (L1)</h4>
                        <ul id="l1-manage-list"></ul>
                    </div>
                    <div class="add-item-form !mt-4">
                        <div class="form-row items-center gap-3">
                            <input type="text" id="new-l1-name" placeholder="新一级分类名称" class="flex-grow">
                            <button onclick="addL1Category()" class="btn-liquid-accent !py-2 !px-4"><i class="fas fa-plus"></i> 添加</button>
                        </div>
                    </div>
                </div>
                <hr class="border-[var(--glass-border)] my-6">
                <div class="manager-section space-y-4">
                     <div>
                        <h4 class="text-lg font-medium mb-2">二级分类 (L2)</h4>
                        <label for="l1-select-for-l2">选择一级分类:</label>
                        <select id="l1-select-for-l2" onchange="renderL2ManagementList()" class="mb-3"></select>
                        <ul id="l2-manage-list"></ul>
                    </div>
                    <div class="add-item-form !mt-4">
                        <div class="form-row items-center gap-3">
                            <input type="text" id="new-l2-name" placeholder="新二级分类名称" class="flex-grow">
                            <button onclick="addL2Category()" class="btn-liquid-accent !py-2 !px-4"><i class="fas fa-plus"></i> 添加</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="routine-manager" class="modal">
             <div class="modal-content">
                <span class="close-btn" onclick="closeModal('routine-manager')">×</span>
                <h3 class="text-xl font-semibold mb-6">管理日常作息项目</h3> <div class="manager-section mb-6">
                    <h4 class="text-lg font-medium mb-2">现有作息项目</h4> <ul id="routine-manage-list"></ul>
                </div>
                <div class="add-item-form">
                    <h5 id="routine-form-title" class="text-lg font-medium mb-4">添加新的作息项目</h5> <input type="hidden" id="editing-routine-original-name" value="">
                     <div class="space-y-4">
                        <div class="form-row items-center">
                            <label for="new-routine-name" class="w-24">项目名称:</label>
                            <input type="text" id="new-routine-name" placeholder="例如：运动, 阅读, 早睡" class="flex-grow"> </div>
                        <div class="form-row items-center">
                            <label for="new-routine-freq-value" class="w-24">频率:</label>
                            <span>每</span>
                            <input type="number" id="new-routine-freq-value" min="1" value="1">
                            <select id="new-routine-freq-unit">
                                <option value="hours">小时</option>
                                <option value="days" selected>天</option>
                            </select>
                            <div class="flex-grow"></div>
                        </div>
                        <div class="form-actions flex justify-start gap-4 pt-3">
                            <button id="add-edit-routine-btn" onclick="addOrUpdateRoutine()" class="btn-liquid-accent"><i class="fas fa-save"></i> 添加项目</button>
                            <button id="cancel-edit-routine-btn" class="btn-liquid-secondary" style="display: none;" onclick="cancelEditRoutine()"><i class="fas fa-times"></i> 取消</button>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <section class="log-display glass-section">
            <h2><i class="fas fa-history"></i>状态日志与洞察</h2> <div id="markdown-output" class="mt-4">日志和洞察将显示在这里...</div> </section>
    </main>

    <footer class="text-center text-xs text-[var(--text-secondary)] opacity-70 pt-6 mt-10 border-t border-[var(--glass-border)]">
         航·序AI - 让AI服务于人 | © 2025 DasterProkio
    </footer>

</div> <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- JS START ---
        const LOCAL_STORAGE_KEY = 'lifeDebuffTrackerData_v3_liquid_hangxu';
        const LOCAL_STORAGE_CSS_KEY = 'lifeDebuffTrackerCustomCSS_v3_liquid_hangxu';

        // --- Default Data (Constants) ---
        const defaultDebuffCategories = {"生理不适":["头痛","胃痛","疲劳","肌肉酸痛","皮肤问题","过敏","其他"],"心理状态":["焦虑","情绪低落","压力大","分心","无聊","烦躁易怒","缺乏动力"],"工作学习":["任务堆积","开会过多","学习困难","被打断","效率低下","沟通不畅"],"环境干扰":["太吵","太乱","空气不好","温度不适","光线刺眼/昏暗"],"生活方面":["睡眠不足","忘记带东西","计划有变","饮食不规律","交通耗时","家务繁重"]};
        const defaultRoutines = [{name:"刷牙",frequency_hours:12,last_completed:null},{name:"洗脸",frequency_hours:12,last_completed:null},{name:"洗澡",frequency_hours:24,last_completed:null},{name:"喝足够水",frequency_hours:8,last_completed:null},{name:"更换毛巾",frequency_days:3,last_completed:null},{name:"换床单",frequency_days:7,last_completed:null},{name:"打扫卫生",frequency_days:3,last_completed:null},{name:"扔垃圾",frequency_days:1,last_completed:null}];

        // --- ** EMBEDDED SAMPLE DATA ** ---
        const sampleData = {
          "logEntries": [
            {"id": "f47ac10b-58cc-4372-a567-0e02b2c3d479","timestamp": "2025-04-19T09:00:00.000Z","type": "routine_completed","routine_name": "刷牙"},
            {"id": "a1b2c3d4-e5f6-7890-1234-567890abcdef","timestamp": "2025-04-19T09:05:00.000Z","type": "routine_completed","routine_name": "洗脸"},
            {"id": "b2c3d4e5-f6a7-8901-2345-67890abcdef0","timestamp": "2025-04-19T10:30:00.000Z","type": "debuff","category1": "工作学习","category2": "任务堆积","duration_estimated": "上午","intensity": 4,"notes": "感觉事情做不完"},
            {"id": "c3d4e5f6-a7b8-9012-3456-7890abcdef01","timestamp": "2025-04-19T14:00:00.000Z","type": "routine_completed","routine_name": "喝足够水"},
            {"id": "d4e5f6a7-b8c9-0123-4567-890abcdef012","timestamp": "2025-04-19T21:00:00.000Z","type": "routine_completed","routine_name": "洗澡"},
            {"id": "e5f6a7b8-c9d0-1234-5678-90abcdef0123","timestamp": "2025-04-19T21:30:00.000Z","type": "routine_completed","routine_name": "刷牙"},
            {"id": "f6a7b8c9-d0e1-2345-6789-0abcdef01234","timestamp": "2025-04-20T08:45:00.000Z","type": "routine_completed","routine_name": "刷牙"},
            {"id": "a7b8c9d0-e1f2-3456-7890-bcdef0123456","timestamp": "2025-04-20T08:50:00.000Z","type": "routine_completed","routine_name": "洗脸"},
            {"id": "b8c9d0e1-f2a3-4567-8901-cdef01234567","timestamp": "2025-04-20T11:00:00.000Z","type": "debuff","category1": "心理状态","category2": "焦虑","duration_estimated": "约1小时","intensity": 3,"notes": "担心下午的会议"},
            {"id": "c9d0e1f2-a3b4-5678-9012-def012345678","timestamp": "2025-04-20T15:00:00.000Z","type": "routine_completed","routine_name": "喝足够水"},
            {"id": "d0e1f2a3-b4c5-6789-0123-ef0123456789","timestamp": "2025-04-20T18:00:00.000Z","type": "routine_completed","routine_name": "运动"}, // Added sample custom routine completion
            {"id": "e1f2a3b4-c5d6-7890-1234-f01234567890","timestamp": "2025-04-20T22:00:00.000Z","type": "routine_completed","routine_name": "洗澡"},
            {"id": "f2a3b4c5-d6e7-8901-2345-01234567890a","timestamp": "2025-04-20T22:30:00.000Z","type": "routine_completed","routine_name": "刷牙"},
            {"id": "a3b4c5d6-e7f8-9012-3456-1234567890ab","timestamp": "2025-04-21T08:30:00.000Z","type": "routine_completed","routine_name": "刷牙"},
            {"id": "b4c5d6e7-f8a9-0123-4567-234567890abc","timestamp": "2025-04-21T08:35:00.000Z","type": "routine_completed","routine_name": "洗脸"},
            {"id": "c5d6e7f8-a9b0-1234-5678-34567890abcd","timestamp": "2025-04-21T10:00:00.000Z","type": "debuff","category1": "生理不适","category2": "疲劳","duration_estimated": null,"intensity": 4,"notes": "昨晚没睡好"}
          ],
          "routine_configs": [
            {"name": "刷牙","frequency_hours": 12,"last_completed": "2025-04-21T08:30:00.000Z"},
            {"name": "洗脸","frequency_hours": 12,"last_completed": "2025-04-21T08:35:00.000Z"},
            {"name": "洗澡","frequency_hours": 24,"last_completed": "2025-04-20T22:00:00.000Z"},
            {"name": "喝足够水","frequency_hours": 8,"last_completed": "2025-04-20T15:00:00.000Z"}, // Will be due soon/overdue depending on current time
            {"name": "更换毛巾","frequency_days": 3,"last_completed": "2025-04-18T12:00:00.000Z"}, // Likely overdue
            {"name": "换床单","frequency_days": 7,"last_completed": "2025-04-14T10:00:00.000Z"}, // Likely overdue
            {"name": "打扫卫生","frequency_days": 3,"last_completed": "2025-04-17T16:00:00.000Z"}, // Likely overdue
            {"name": "扔垃圾","frequency_days": 1,"last_completed": "2025-04-20T22:10:00.000Z"}, // Should be okay
            {"name": "运动","frequency_days": 1,"last_completed": "2025-04-20T18:00:00.000Z"}, // Custom routine, done yesterday
            {"name": "阅读","frequency_days": 1,"last_completed": "2025-04-19T23:00:00.000Z"} // Custom routine, done day before yesterday
          ],
          "customDebuffCategories": {
            "生理不适": ["头痛","胃痛","疲劳","肌肉酸痛","皮肤问题","过敏","其他"],
            "心理状态": ["焦虑","情绪低落","压力大","分心","无聊","烦躁易怒","缺乏动力"],
            "工作学习": ["任务堆积","开会过多","学习困难","被打断","效率低下","沟通不畅"],
            "环境干扰": ["太吵","太乱","空气不好","温度不适","光线刺眼/昏暗"],
            "生活方面": ["睡眠不足","忘记带东西","计划有变","饮食不规律","交通耗时","家务繁重"],
            "社交活动": ["聚餐后不适","线上会议疲劳"] // Sample custom category
          }
        };
        // --- END SAMPLE DATA ---


        // State
        let appData = {}; // Initialize empty, loadData will populate
        let debuffLogState = { category1: null, category2: null };

        // DOM Elements Cache (assuming IDs match HTML)
        const getEl = (id) => document.getElementById(id); // Helper
        const l1CategoriesDisplayEl=getEl('l1-categories-display');
        const debuffLoggerModal=getEl('debuff-logger');
        const category2OptionsContainer=getEl('category2-options');
        const category2ButtonsEl=getEl('category2-buttons');
        const debuffDetailsEl=getEl('debuff-details');
        const selectedCat1Display=getEl('selected-cat1-display');
        const selectedCat2Display=getEl('selected-cat2-display');
        const debuffDurationInput=getEl('debuff-duration');
        const debuffIntensitySlider=getEl('debuff-intensity-slider');
        const intensityValueDisplay=getEl('intensity-value-display');
        const debuffNotesInput=getEl('debuff-notes');
        const submitDebuffBtn=getEl('submit-debuff-btn');
        const debuffBackBtn=getEl('debuff-back-btn');
        const potentialDebuffsListEl=getEl('potential-debuffs-list');
        const routineListEl=getEl('routine-list');
        const exportBtn=getEl('export-data-btn');
        const importFileInput=getEl('import-file-input');
        const importStatusEl=getEl('import-status');
        const manageCategoriesBtn=getEl('manage-categories-btn');
        const categoryManagerModal=getEl('category-manager');
        const l1ManageListEl=getEl('l1-manage-list');
        const l1SelectForL2El=getEl('l1-select-for-l2');
        const l2ManageListEl=getEl('l2-manage-list');
        const newL1NameInput=getEl('new-l1-name');
        const newL2NameInput=getEl('new-l2-name');
        const manageRoutinesBtn=getEl('manage-routines-btn');
        const routineManagerModal=getEl('routine-manager');
        const routineManageListEl=getEl('routine-manage-list');
        const routineFormTitle=getEl('routine-form-title');
        const newRoutineNameInput=getEl('new-routine-name');
        const newRoutineFreqValueInput=getEl('new-routine-freq-value');
        const newRoutineFreqUnitSelect=getEl('new-routine-freq-unit');
        const addEditRoutineBtn=getEl('add-edit-routine-btn');
        const cancelEditRoutineBtn=getEl('cancel-edit-routine-btn');
        const editingRoutineOriginalNameInput=getEl('editing-routine-original-name');
        const markdownOutputEl=getEl('markdown-output');
        const importCssInput=getEl('import-css-input');
        const removeCssBtn=getEl('remove-css-btn');
        const cssImportStatusEl=getEl('css-import-status');

        // --- Core Data Functions ---
        // ** MODIFIED loadData **
        function loadData() {
            const dataString = localStorage.getItem(LOCAL_STORAGE_KEY);
            let loadedSuccessfully = false; // Flag

            if (dataString) {
                try {
                    const parsedData = JSON.parse(dataString);
                    // Basic validation
                    if (parsedData && typeof parsedData === 'object' &&
                        Array.isArray(parsedData.logEntries) &&
                        Array.isArray(parsedData.routine_configs) &&
                        typeof parsedData.customDebuffCategories === 'object' && parsedData.customDebuffCategories !== null)
                    {
                        appData = parsedData;
                        // Ensure defaults compatibility (optional, but good practice)
                        ensureAllDefaultRoutinesExist(false);
                         if (!appData.customDebuffCategories || Object.keys(appData.customDebuffCategories).length === 0) {
                             appData.customDebuffCategories = JSON.parse(JSON.stringify(defaultDebuffCategories));
                         }
                        loadedSuccessfully = true;
                        console.log("Data loaded from localStorage:", appData);
                    } else {
                        console.warn("Loaded data structure invalid, will use sample data.");
                    }
                } catch (e) {
                    console.error("Error parsing data from localStorage, will use sample data:", e);
                }
            }

            // If loading failed or no data exists, load the embedded sample data
            if (!loadedSuccessfully) {
                console.log("No valid data in localStorage, loading embedded sample data...");
                // Use a deep copy of sampleData to prevent modifying the original const
                appData = JSON.parse(JSON.stringify(sampleData));
                // Still good to ensure defaults compatibility even with sample data
                ensureAllDefaultRoutinesExist(false);
                 if (!appData.customDebuffCategories || Object.keys(appData.customDebuffCategories).length === 0) {
                     appData.customDebuffCategories = JSON.parse(JSON.stringify(defaultDebuffCategories));
                 }
                console.log("Sample data loaded:", appData);
                // **Important:** Do NOT immediately save sample data back to localStorage here.
                // Let user interactions trigger saves later.
            }
        }

        // This function now primarily ensures default routines/categories are present
        // if the loaded data (from storage or sample) is missing them.
        function ensureAllDefaultRoutinesExist(forceIfListEmpty = false) {
            if (!appData.routine_configs || !Array.isArray(appData.routine_configs)) {
                 console.warn("routine_configs missing or invalid, initializing with defaults.");
                 appData.routine_configs = JSON.parse(JSON.stringify(defaultRoutines));
                 return; // Exit after initializing
            }
             if (forceIfListEmpty && appData.routine_configs.length === 0) {
                 console.log("Routine list empty, forcing defaults.");
                 appData.routine_configs = JSON.parse(JSON.stringify(defaultRoutines));
                 return;
            }

            const existingNames = new Set(appData.routine_configs.map(r => r.name));
            let changed = false;
            defaultRoutines.forEach(defaultRoutine => {
                if (!existingNames.has(defaultRoutine.name)) {
                    appData.routine_configs.push(JSON.parse(JSON.stringify(defaultRoutine)));
                    console.log(`Added missing default routine: ${defaultRoutine.name}`);
                    changed = true;
                }
            });

            // Ensure default categories exist if customDebuffCategories is somehow empty object
             if (!appData.customDebuffCategories || typeof appData.customDebuffCategories !== 'object') {
                 console.warn("customDebuffCategories missing or invalid, initializing with defaults.");
                 appData.customDebuffCategories = JSON.parse(JSON.stringify(defaultDebuffCategories));
                 changed = true;
             } else if (Object.keys(appData.customDebuffCategories).length === 0) {
                  console.log("customDebuffCategories empty, initializing with defaults.");
                  appData.customDebuffCategories = JSON.parse(JSON.stringify(defaultDebuffCategories));
                  changed = true;
             }

             // Only save if changes were made by this function (optional)
             // if (changed) saveData();
        }

        function saveData() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        function addLogEntry(entryData) {
            const newEntry = {
                id: generateUUID(),
                timestamp: new Date().toISOString(),
                ...entryData
            };
            // Ensure logEntries exists and is an array
            if (!Array.isArray(appData.logEntries)) {
                 appData.logEntries = [];
             }
            appData.logEntries.push(newEntry);
            saveData();
            renderDashboard();
        }

        function generateUUID() { // Simple UUID generator
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- Rendering Functions (Keep the robust versions from previous step) ---
         function renderUI() {
             renderL1Categories();
             renderDashboard();
         }

         function renderL1Categories() {
             l1CategoriesDisplayEl.innerHTML = '';
             const categories = appData.customDebuffCategories;
              if (!categories || typeof categories !== 'object' || Object.keys(categories).length === 0) {
                  l1CategoriesDisplayEl.innerHTML = '<p class="text-sm text-[var(--text-secondary)] opacity-80">无状态分类。请在设置中添加。</p>';
                  return;
              }
             Object.keys(categories).sort().forEach(cat1 => {
                 const btn = document.createElement('button');
                 btn.textContent = cat1;
                 btn.className = 'btn-liquid-secondary lift-element';
                 btn.onclick = () => startDebuffLogFlow(cat1);
                 l1CategoriesDisplayEl.appendChild(btn);
             });
         }

         function renderDashboard() {
             renderRoutineStatus();
             renderPotentialDebuffs();
             renderMarkdownPreview();
         }

         // ** Robust formatRelativeTime ** (Keep the enhanced version)
          function formatRelativeTime(dS) {
              if (!dS) return "从未";
              if (typeof dS !== 'string') {
                  console.error("formatRelativeTime received non-string:", dS, typeof dS);
                  return "类型错误";
              }
              try {
                  const d = new Date(dS);
                  if (isNaN(d.getTime())) {
                      console.warn("formatRelativeTime received invalid date string:", dS);
                      return "无效日期";
                  }
                  const n = new Date();
                  const diffSeconds = Math.round((n.getTime() - d.getTime()) / 1000);
                  if (isNaN(diffSeconds)) {
                      console.error("formatRelativeTime calculation resulted in NaN. Input:", dS, "Parsed Date:", d);
                      return "计算错误";
                  }
                  const diffMinutes = Math.round(diffSeconds / 60);
                  const diffHours = Math.round(diffMinutes / 60);
                  const diffDays = Math.round(diffHours / 24);
                  if (diffSeconds < 60) return `刚刚`;
                  if (diffMinutes < 60) return `${diffMinutes}分钟前`;
                  if (diffHours < 24) return `${diffHours}小时前`;
                  if (diffDays === 1) return "昨天";
                  if (diffDays < 7) return `${diffDays}天前`;
                  try {
                      return d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                  } catch (toLocaleError) {
                      console.error("Error during toLocaleDateString:", toLocaleError, "Date Object:", d);
                      return "格式化错误";
                  }
              } catch (e) {
                  console.error("Unexpected error in formatRelativeTime:", e, "Input was:", dS);
                  return "处理错误";
              }
          }

         // ** Robust getOverdueStatus ** (Keep the enhanced version)
           function getOverdueStatus(routine) {
               if (!routine || typeof routine !== 'object' || !routine.name) {
                   console.warn("Invalid routine object passed to getOverdueStatus:", routine);
                   return { overdue: false, hoursLeft: Infinity, statusClass: '', message: '无效项目' };
               }
               const lastCompleted = routine.last_completed;
               if (!lastCompleted) {
                   let frequencyMillis = 0;
                   if (routine.frequency_hours) frequencyMillis = routine.frequency_hours * 3600000;
                   else if (routine.frequency_days) frequencyMillis = routine.frequency_days * 86400000;
                   const isOverdueInitially = frequencyMillis > 0;
                   return { overdue: isOverdueInitially, hoursLeft: -Infinity, statusClass: isOverdueInitially ? 'overdue-true' : '', message: isOverdueInitially ? '从未完成' : '无频率/未开始' }; // Clarified message
               }
               try {
                   const lastCompletedDate = new Date(lastCompleted);
                   if (isNaN(lastCompletedDate.getTime())) {
                       console.warn(`Invalid last_completed date for routine "${routine.name}":`, lastCompleted);
                       return { overdue: true, hoursLeft: -Infinity, statusClass: 'overdue-true', message: '日期无效' }; // Changed from '上次完成日期无效'
                   }
                   const now = new Date();
                   let frequencyMillis;
                   if (routine.frequency_hours) { frequencyMillis = routine.frequency_hours * 3600000; }
                   else if (routine.frequency_days) { frequencyMillis = routine.frequency_days * 86400000; }
                   else { return { overdue: false, hoursLeft: Infinity, statusClass: '', message: '无频率' }; }
                   const dueDate = new Date(lastCompletedDate.getTime() + frequencyMillis);
                   const millisLeft = dueDate.getTime() - now.getTime();
                   const hoursLeft = millisLeft / 3600000;
                   let statusClass = 'overdue-false';
                   let message = "";
                   let overdue = false;
                   const soonThresholdHours = Math.max(1, (frequencyMillis / 3600000) * 0.2);
                   if (hoursLeft <= 0) {
                       overdue = true; statusClass = 'overdue-true';
                       const hoursOverdue = Math.abs(Math.round(hoursLeft));
                       if (hoursOverdue >= 48) { message = `逾期 ${Math.round(hoursOverdue / 24)} 天`; }
                       else if (hoursOverdue > 0) { message = `逾期 ${hoursOverdue} 小时`; }
                       else { message = `刚刚到期`; }
                   } else if (hoursLeft < soonThresholdHours) {
                       statusClass = 'overdue-soon';
                       if (hoursLeft * 60 < 60) { message = `${Math.ceil(hoursLeft * 60)} 分钟内`; } // Simplified
                       else { message = `${Math.ceil(hoursLeft)} 小时内`; } // Simplified
                       message += '到期'; // Added '到期' here
                   } else {
                       if (hoursLeft >= 48) { message = `${Math.floor(hoursLeft / 24)} 天后到期`; }
                       else { message = `${Math.ceil(hoursLeft)} 小时后到期`; }
                   }
                   return { overdue, hoursLeft, statusClass, message };
               } catch (e) {
                   console.error(`Error calculating overdue status for routine "${routine.name}":`, e);
                   return { overdue: true, hoursLeft: -Infinity, statusClass: 'overdue-true', message: '计算错误' }; // Changed from '状态计算错误'
               }
           }

         // ** renderRoutineStatus ** (Keep the enhanced version)
          function renderRoutineStatus() {
              routineListEl.innerHTML = '';
              if (!appData.routine_configs || !Array.isArray(appData.routine_configs) || appData.routine_configs.length === 0) {
                  routineListEl.innerHTML = '<li class="text-sm text-[var(--text-secondary)] opacity-80">无日常作息项目。请在设置中添加。</li>';
                  return;
              }
              const sortedRoutines = [...appData.routine_configs].sort((a, b) => { /* ... keep sorting logic ... */
                  const statusA = getOverdueStatus(a);
                  const statusB = getOverdueStatus(b);
                  const overdueScore = (s) => s.overdue ? 2 : (s.statusClass === 'overdue-soon' ? 1 : 0);
                  const statusDiff = overdueScore(statusB) - overdueScore(statusA);
                  if (statusDiff !== 0) return statusDiff;
                  if (statusA.hoursLeft !== statusB.hoursLeft) return statusA.hoursLeft - statusB.hoursLeft;
                  return a.name.localeCompare(b.name);
               });
              sortedRoutines.forEach(routine => {
                  const li = document.createElement('li');
                  const status = getOverdueStatus(routine);
                  const formattedLastTime = formatRelativeTime(routine.last_completed);
                  const lastCompletedClass = formattedLastTime.includes('错误') || formattedLastTime.includes('无效') ? 'last-completed date-error' : 'last-completed';
                  li.innerHTML = `
                      <div class="routine-info">
                          <span class="routine-name">${routine.name}</span>
                          <span class="${lastCompletedClass}">上次: ${formattedLastTime}</span>
                          <span class="status-message ${status.statusClass}">${status.message}</span>
                      </div>
                      <button class="routine-done-btn lift-element" data-routine-name="${routine.name}" title="标记 ${routine.name} 为完成">
                          <i class="fas fa-check"></i>
                      </button>`;
                  routineListEl.appendChild(li);
              });
          }

         // ** renderPotentialDebuffs ** (Keep the enhanced version)
          function renderPotentialDebuffs() {
              potentialDebuffsListEl.innerHTML = '';
              let hasPotentialDebuffs = false;
              if (!appData.routine_configs || !Array.isArray(appData.routine_configs)) {
                  potentialDebuffsListEl.innerHTML = '<li class="text-sm text-[var(--text-secondary)] opacity-80">无法加载建议，无作息项目。</li>';
                  return;
              }
              appData.routine_configs.forEach(routine => {
                  const status = getOverdueStatus(routine);
                  let suggestion = null;
                  if (status.overdue) {
                      suggestion = "尽快完成。";
                      const hoursOverdue = Math.abs(status.hoursLeft);
                      // Simplified suggestions
                      if (routine.name === "喝足够水" && hoursOverdue > 3) suggestion = "及时补充水分，可能影响精力。";
                      if (routine.name === "扔垃圾" && hoursOverdue > 12) suggestion = "清理垃圾防异味。";
                      if (routine.name === "打扫卫生" && hoursOverdue > 48) suggestion = "环境整洁有助心情。";
                      // ... add more specific suggestions based on routine name ...
                  }
                  if (suggestion) {
                      hasPotentialDebuffs = true;
                      const li = document.createElement('li');
                      li.innerHTML = `<span class="font-medium text-[var(--text-primary)] opacity-90">**${routine.name}**</span> <span class="text-[var(--text-secondary)]">${status.message}. ${suggestion}</span>`;
                      potentialDebuffsListEl.appendChild(li);
                  }
              });
              if (!hasPotentialDebuffs) {
                  potentialDebuffsListEl.innerHTML = '<li class="text-sm text-green-400 flex items-center"><i class="fas fa-check-circle mr-2"></i>当前状态良好，无明显待办提醒。</li>';
              }
          }

         // ** Markdown Preview Functions ** (Keep the enhanced versions)
         function basicMarkdownToHtml(md) { /* ... keep enhanced version ... */
             let html = md;
             let lines = html.split('\n');
             let inList = false;
             html = lines.map(line => {
                 if (line.startsWith('### ')) {
                     let listEnd = '';
                     if (inList) { inList = false; listEnd = '</ul>'; }
                     return `${listEnd}<h3 class="text-base font-semibold mt-4 mb-2 border-b border-[var(--glass-border)] pb-1">${line.substring(4)}</h3>`;
                 } else if (line.startsWith('* ')) { // Changed from '* ' to handle potential spaces
                     let itemContent = line.substring(line.indexOf('* ') + 2); // Get content after '* '
                     itemContent = itemContent.replace(/\*\*(.*?)\*\*/g, '<strong class="text-[var(--text-primary)] opacity-95">$1</strong>');
                     if (!inList) { inList = true; return `<ul><li>${itemContent}</li>`; }
                     return `<li>${itemContent}</li>`;
                 } else {
                     let listEnd = '';
                     if (inList) { inList = false; listEnd = '</ul>'; }
                     let processedLine = line.replace(/\*\*(.*?)\*\*/g, '<strong class="text-[var(--text-primary)] opacity-95">$1</strong>');
                     return listEnd + (processedLine.trim() ? `<p>${processedLine}</p>` : ''); // Only add P if line has content
                 }
             }).join('');
             if (inList) { html += '</ul>'; }
             return html.trim();
          }
         function renderMarkdownPreview() { /* ... keep enhanced version ... */
            let markdownSections = [];
            const todayStr = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
            markdownSections.push(`### 状态日志 (${todayStr})`);
            markdownSections.push("\n### 潜在关联与建议");
            const potentialItems = potentialDebuffsListEl.querySelectorAll('li');
            if (potentialItems.length > 0 && !potentialItems[0].textContent.includes('状态良好')) {
                potentialItems.forEach(item => {
                    let text = item.innerHTML.replace(/<span class="font-medium.*?>(.*?)<\/span>/g, '$1');
                    text = text.replace(/<strong(.*?)>(.*?)<\/strong>/g, '**$2**');
                    text = text.replace(/<[^>]*>/g, '').trim();
                     if (item.querySelector('.font-medium')) {
                         const routineName = item.querySelector('.font-medium').textContent;
                         text = text.replace(routineName, `**${routineName}**`);
                     }
                    markdownSections.push(`* ${text}`);
                });
            } else { markdownSections.push("* 当前状态良好，无明显待办提醒。"); }
            markdownSections.push("\n### 最近状态记录 (Debuff)");
            const debuffLogs = (appData.logEntries || [])
                .filter(entry => entry.type === 'debuff')
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            if (debuffLogs.length > 0) {
                debuffLogs.forEach(entry => {
                    const time = new Date(entry.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    let logLine = `* [${time}] **${entry.category1} / ${entry.category2}**:`;
                    if (entry.intensity) logLine += ` 强度 ${entry.intensity}`;
                    if (entry.duration_estimated) logLine += ` (${entry.duration_estimated})`;
                    if (entry.notes) logLine += ` - ${entry.notes}`;
                    markdownSections.push(logLine);
                });
            } else { markdownSections.push("* 最近无记录"); }
             markdownSections.push("\n### 今日完成 (Routine)");
             const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
             const tomorrowStart = new Date(todayStart); tomorrowStart.setDate(todayStart.getDate() + 1);
             const completedToday = (appData.logEntries || [])
                 .filter(entry => {
                     try {
                         const entryDate = new Date(entry.timestamp);
                         return entry.type === 'routine_completed' && !isNaN(entryDate) && entryDate >= todayStart && entryDate < tomorrowStart;
                      } catch { return false; }
                 })
                 .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
             if (completedToday.length > 0) {
                 completedToday.forEach(entry => {
                     const time = new Date(entry.timestamp).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                     markdownSections.push(`* [${time}] **${entry.routine_name}**`);
                 });
             } else { markdownSections.push("* 今日尚未完成任何作息项目"); }
              markdownSections.push("\n### 日常作息状态总览");
              const routinesToLog = appData.routine_configs || [];
              const sortedRoutinesForLog = [...routinesToLog].sort((a, b) => {
                  const statusA = getOverdueStatus(a); const statusB = getOverdueStatus(b);
                  const overdueScore = (s) => s.overdue ? 2 : (s.statusClass === 'overdue-soon' ? 1 : 0);
                  const statusDiff = overdueScore(statusB) - overdueScore(statusA);
                  if (statusDiff !== 0) return statusDiff;
                  if (statusA.hoursLeft !== statusB.hoursLeft) return statusA.hoursLeft - statusB.hoursLeft;
                  return a.name.localeCompare(b.name);
              });
              if (sortedRoutinesForLog.length > 0) {
                   sortedRoutinesForLog.forEach(routine => {
                       const status = getOverdueStatus(routine);
                       const lastTime = formatRelativeTime(routine.last_completed);
                       let statusIcon = '⚪';
                       if (lastTime.includes('错误') || lastTime.includes('无效')) statusIcon = '❓';
                       else if (status.overdue) statusIcon = '🔴';
                       else if (status.statusClass === 'overdue-soon') statusIcon = '🟡';
                       else if (lastTime !== '从未' && lastTime !== '无频率/未开始') statusIcon = '🟢';
                       markdownSections.push(`* **${routine.name}**: ${statusIcon} (${status.message}, 上次: ${lastTime})`);
                   });
              } else { markdownSections.push("* 无日常作息项目"); }
            const markdownString = markdownSections.join('\n');
            const generatedHtml = basicMarkdownToHtml(markdownString);
            markdownOutputEl.innerHTML = generatedHtml || '<p class="text-sm text-[var(--text-secondary)] opacity-80">暂无日志或洞察。</p>';
         }

        // --- Debuff Logging Flow --- (Keep enhanced version)
         function startDebuffLogFlow(cat1) { /* ... keep enhanced version ... */
             if (!appData.customDebuffCategories || !appData.customDebuffCategories[cat1]) { console.error(`Category ${cat1} not found.`); return; }
             debuffLogState.category1 = cat1; debuffLogState.category2 = null;
             selectedCat1Display.textContent = cat1;
             debuffLoggerModal.querySelector('#debuff-modal-title').textContent = `记录状态: ${cat1}`;
             category2ButtonsEl.innerHTML = '';
             const l2Options = appData.customDebuffCategories[cat1];
             if (l2Options && Array.isArray(l2Options) && l2Options.length > 0) {
                 l2Options.sort().forEach(cat2 => {
                     const btn = document.createElement('button'); btn.textContent = cat2;
                     btn.className = 'btn-liquid-secondary lift-element'; btn.onclick = () => selectL2Category(cat2);
                     category2ButtonsEl.appendChild(btn);
                 });
                 category2OptionsContainer.style.display = 'block'; debuffDetailsEl.style.display = 'none'; debuffBackBtn.style.display = 'none';
             } else { selectL2Category("(无二级分类)"); }
             resetDebuffDetailsInputs(); openModal('debuff-logger');
         }
         function selectL2Category(cat2) { debuffLogState.category2 = cat2; showDebuffDetails(cat2); }
         function showDebuffDetails(cat2) { selectedCat2Display.textContent = `${debuffLogState.category1} / ${cat2}`; category2OptionsContainer.style.display = 'none'; debuffDetailsEl.style.display = 'block'; const l2Options = appData.customDebuffCategories[debuffLogState.category1]; debuffBackBtn.style.display = (l2Options && l2Options.length > 0) ? 'inline-flex' : 'none'; }
         function resetDebuffDetailsInputs() { debuffDurationInput.value = ''; debuffIntensitySlider.value = 3; intensityValueDisplay.textContent = '3'; debuffNotesInput.value = ''; }
         window.goBackToL2 = function() { debuffLogState.category2 = null; debuffDetailsEl.style.display = 'none'; category2OptionsContainer.style.display = 'block'; debuffBackBtn.style.display = 'none'; }
         function submitDebuff() { if (!debuffLogState.category1 || !debuffLogState.category2) { console.error("Category not selected."); return; } const debuffData = { type: 'debuff', category1: debuffLogState.category1, category2: debuffLogState.category2, duration_estimated: debuffDurationInput.value.trim() || null, intensity: parseInt(debuffIntensitySlider.value, 10), notes: debuffNotesInput.value.trim() || null }; addLogEntry(debuffData); closeModal('debuff-logger'); }

        // --- Modal Handling --- (Keep enhanced version)
         window.openModal = function(id) { const modal = getEl(id); if(modal) modal.style.display = 'block'; }
         window.closeModal = function(id) { const modal = getEl(id); if(modal) modal.style.display = 'none'; if (id === 'debuff-logger') resetDebuffLoggerState(); if (id === 'routine-manager') resetRoutineForm(); }
         window.onclick = function(event) { if (event.target.classList.contains('modal')) { closeModal(event.target.id); } }
         function resetDebuffLoggerState(){ debuffLogState = { category1: null, category2: null }; if (debuffDetailsEl) debuffDetailsEl.style.display = 'none'; if (category2OptionsContainer) category2OptionsContainer.style.display = 'block'; }

        // --- Category Management --- (Keep enhanced version with listeners)
        manageCategoriesBtn.addEventListener('click', () => { renderCategoryManager(); openModal('category-manager'); });
        function renderCategoryManager() { renderL1ManagementList(); renderL1SelectOptions(); renderL2ManagementList(); }
        function renderL1ManagementList() { /* ... keep enhanced version with listeners ... */
            l1ManageListEl.innerHTML = ''; const l1Categories = Object.keys(appData.customDebuffCategories || {}).sort();
             if (l1Categories.length === 0) { l1ManageListEl.innerHTML = '<li class="text-sm text-[var(--text-secondary)] opacity-80">无一级分类。</li>'; return; }
             l1Categories.forEach(cat1 => { const li = document.createElement('li'); li.className = 'flex justify-between items-center py-2'; li.innerHTML = `<span class="item-name flex-grow mr-2">${cat1}</span><div class="action-buttons space-x-2 flex-shrink-0"><button class="btn-action btn-edit" data-l1="${cat1}"><i class="fas fa-pencil-alt"></i></button><button class="btn-action btn-delete" data-l1="${cat1}"><i class="fas fa-trash"></i></button></div>`; l1ManageListEl.appendChild(li); });
             l1ManageListEl.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', (e) => editL1CategoryWrapper(e.currentTarget.dataset.l1))); l1ManageListEl.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', (e) => deleteL1CategoryWrapper(e.currentTarget.dataset.l1)));
         }
        function renderL1SelectOptions() { /* ... keep enhanced version ... */
            l1SelectForL2El.innerHTML = '<option value="">-- 选择一级分类 --</option>'; const l1Categories = Object.keys(appData.customDebuffCategories || {}).sort(); l1Categories.forEach(cat1 => { const option = document.createElement('option'); option.value = cat1; option.textContent = cat1; l1SelectForL2El.appendChild(option); });
        }
        window.renderL2ManagementList = function() { /* ... keep enhanced version with listeners ... */
             l2ManageListEl.innerHTML = ''; const selectedL1 = l1SelectForL2El.value;
             if (!selectedL1) { l2ManageListEl.innerHTML = '<li class="text-sm text-[var(--text-secondary)] opacity-80">请先在上方选择一个一级分类。</li>'; return; }
             const l2Categories = appData.customDebuffCategories[selectedL1]?.sort() || [];
             if (l2Categories.length === 0) { l2ManageListEl.innerHTML = `<li class="text-sm text-[var(--text-secondary)] opacity-80">"${selectedL1}" 下无二级分类。</li>`; return; }
             l2Categories.forEach(cat2 => { const li = document.createElement('li'); li.className = 'flex justify-between items-center py-2'; li.innerHTML = `<span class="item-name flex-grow mr-2">${cat2}</span><div class="action-buttons space-x-2 flex-shrink-0"><button class="btn-action btn-edit" data-l1="${selectedL1}" data-l2="${cat2}"><i class="fas fa-pencil-alt"></i></button><button class="btn-action btn-delete" data-l1="${selectedL1}" data-l2="${cat2}"><i class="fas fa-trash"></i></button></div>`; l2ManageListEl.appendChild(li); });
             l2ManageListEl.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', (e) => editL2CategoryWrapper(e.currentTarget.dataset.l1, e.currentTarget.dataset.l2))); l2ManageListEl.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', (e) => deleteL2CategoryWrapper(e.currentTarget.dataset.l1, e.currentTarget.dataset.l2)));
         }
        window.addL1Category = function() { /* ... keep enhanced version ... */
             const name = newL1NameInput.value.trim(); if (!name) return; if (appData.customDebuffCategories[name]) { alert(`分类 "${name}" 已存在!`); return; } appData.customDebuffCategories[name] = []; saveData(); renderL1Categories(); renderCategoryManager(); newL1NameInput.value = '';
         }
        window.editL1CategoryWrapper = function(originalName) { /* ... keep enhanced version ... */
            if (!originalName) return; const newName = prompt(`输入新的名称 for "${originalName}":`, originalName); if (newName === null || newName.trim() === '' || newName.trim() === originalName) return; const finalNewName = newName.trim(); if (appData.customDebuffCategories[finalNewName]) { alert(`名称 "${finalNewName}" 已存在!`); return; } appData.customDebuffCategories[finalNewName] = appData.customDebuffCategories[originalName]; delete appData.customDebuffCategories[originalName]; saveData(); renderL1Categories(); renderCategoryManager();
         }
        window.deleteL1CategoryWrapper = function(name) { /* ... keep enhanced version ... */
             if (!name || !appData.customDebuffCategories[name]) return; const l2Count = appData.customDebuffCategories[name]?.length || 0; const confirmMsg = `确定要删除一级分类 "${name}" 吗?` + (l2Count > 0 ? `\n其下的 ${l2Count} 个二级分类也将一并删除!` : ''); if (confirm(confirmMsg)) { delete appData.customDebuffCategories[name]; saveData(); renderL1Categories(); renderCategoryManager(); }
         }
        window.addL2Category = function() { /* ... keep enhanced version ... */
            const selectedL1 = l1SelectForL2El.value; if (!selectedL1) { alert("请先选择一个一级分类。"); return; } const name = newL2NameInput.value.trim(); if (!name) return; if (!appData.customDebuffCategories[selectedL1] || !Array.isArray(appData.customDebuffCategories[selectedL1])) { appData.customDebuffCategories[selectedL1] = []; } if (appData.customDebuffCategories[selectedL1].includes(name)) { alert(`二级分类 "${name}" 在 "${selectedL1}" 下已存在!`); return; } appData.customDebuffCategories[selectedL1].push(name); saveData(); renderL2ManagementList(); newL2NameInput.value = '';
         }
        window.editL2CategoryWrapper = function(l1Name, originalL2Name) { /* ... keep enhanced version ... */
             if (!l1Name || !originalL2Name || !appData.customDebuffCategories[l1Name]) return; const newL2Name = prompt(`输入 "${originalL2Name}" (在 ${l1Name} 下) 的新名称:`, originalL2Name); if (newL2Name === null || newL2Name.trim() === '' || newL2Name.trim() === originalL2Name) return; const finalNewL2Name = newL2Name.trim(); const l2List = appData.customDebuffCategories[l1Name]; if (l2List.includes(finalNewL2Name)) { alert(`名称 "${finalNewL2Name}" 在 "${l1Name}" 下已存在!`); return; } const index = l2List.indexOf(originalL2Name); if (index > -1) { l2List[index] = finalNewL2Name; saveData(); renderL2ManagementList(); }
         }
         window.deleteL2CategoryWrapper = function(l1Name, l2Name) { /* ... keep enhanced version ... */
             if (!l1Name || !l2Name || !appData.customDebuffCategories[l1Name]) return; if (confirm(`确定要删除二级分类 "${l2Name}" (在 "${l1Name}" 下) 吗?`)) { const l2List = appData.customDebuffCategories[l1Name]; const index = l2List.indexOf(l2Name); if (index > -1) { l2List.splice(index, 1); saveData(); renderL2ManagementList(); } }
         }

        // --- Routine Management --- (Keep enhanced version with listeners)
        manageRoutinesBtn.addEventListener('click', () => { resetRoutineForm(); renderRoutineManager(); openModal('routine-manager'); });
        function formatFrequency(routine) { /* ... keep function ... */ if (routine.frequency_hours) return `每 ${routine.frequency_hours} 小时`; else if (routine.frequency_days) return `每 ${routine.frequency_days} 天`; else return "无频率设定"; }
        function renderRoutineManager() { /* ... keep enhanced version with listeners ... */
             routineManageListEl.innerHTML = ''; if (!appData.routine_configs || !Array.isArray(appData.routine_configs) || appData.routine_configs.length === 0) { routineManageListEl.innerHTML = '<li class="text-sm text-[var(--text-secondary)] opacity-80">无日常作息项目。</li>'; return; } const sortedRoutines = [...appData.routine_configs].sort((a, b) => a.name.localeCompare(b.name)); sortedRoutines.forEach(routine => { const li = document.createElement('li'); li.className = 'flex justify-between items-center py-2'; li.innerHTML = `<div class="item-details flex-grow"><span class="item-name">${routine.name}</span><span class="item-frequency ml-4">${formatFrequency(routine)}</span></div><div class="action-buttons space-x-2 flex-shrink-0"><button class="btn-action btn-edit" data-name="${routine.name}"><i class="fas fa-pencil-alt"></i></button><button class="btn-action btn-delete" data-name="${routine.name}"><i class="fas fa-trash"></i></button></div>`; routineManageListEl.appendChild(li); }); routineManageListEl.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', (e) => editRoutineWrapper(e.currentTarget.dataset.name))); routineManageListEl.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', (e) => deleteRoutineWrapper(e.currentTarget.dataset.name)));
         }
        function resetRoutineForm() { /* ... keep function ... */ routineFormTitle.textContent = "添加新的作息项目"; newRoutineNameInput.value = ''; newRoutineFreqValueInput.value = '1'; newRoutineFreqUnitSelect.value = 'days'; editingRoutineOriginalNameInput.value = ''; addEditRoutineBtn.innerHTML = '<i class="fas fa-plus"></i> 添加项目'; addEditRoutineBtn.className = 'btn-liquid-accent'; cancelEditRoutineBtn.style.display = 'none'; newRoutineNameInput.disabled = false; }
        window.addOrUpdateRoutine = function() { /* ... keep enhanced version ... */
             const originalName = editingRoutineOriginalNameInput.value; const isEditing = !!originalName; const name = newRoutineNameInput.value.trim(); const freqValue = parseInt(newRoutineFreqValueInput.value, 10); const freqUnit = newRoutineFreqUnitSelect.value; if (!name) { alert("请输入项目名称。"); return; } if (isNaN(freqValue) || freqValue <= 0) { alert("请输入有效的频率数值 (大于0)。"); return; } const nameExists = appData.routine_configs.some(r => r.name === name); if ((!isEditing && nameExists) || (isEditing && name !== originalName && nameExists)) { alert(`名称为 "${name}" 的项目已存在!`); return; } const routineData = { name: name, frequency_hours: freqUnit === 'hours' ? freqValue : null, frequency_days: freqUnit === 'days' ? freqValue : null, last_completed: null }; if (isEditing) { const index = appData.routine_configs.findIndex(r => r.name === originalName); if (index > -1) { routineData.last_completed = appData.routine_configs[index].last_completed; appData.routine_configs[index] = routineData; } else { console.error("Error editing: Original routine not found."); resetRoutineForm(); return; } } else { appData.routine_configs.push(routineData); } saveData(); renderRoutineManager(); renderDashboard(); resetRoutineForm();
         }
        window.editRoutineWrapper = function(routineName) { /* ... keep enhanced version ... */
             if (!routineName) return; const routine = appData.routine_configs.find(r => r.name === routineName); if (!routine) return; routineFormTitle.textContent = `编辑项目: ${routineName}`; newRoutineNameInput.value = routine.name; newRoutineFreqValueInput.value = routine.frequency_hours || routine.frequency_days || 1; newRoutineFreqUnitSelect.value = routine.frequency_hours ? 'hours' : 'days'; editingRoutineOriginalNameInput.value = routineName; addEditRoutineBtn.innerHTML = '<i class="fas fa-save"></i> 保存更改'; addEditRoutineBtn.className = 'btn-liquid-secondary'; cancelEditRoutineBtn.style.display = 'inline-flex';
         }
         window.cancelEditRoutine = function() { resetRoutineForm(); }
         window.deleteRoutineWrapper = function(routineName) { /* ... keep enhanced version ... */
             if (!routineName) return; if (confirm(`确定要删除日常作息项目 "${routineName}" 吗?`)) { const index = appData.routine_configs.findIndex(r => r.name === routineName); if (index > -1) { appData.routine_configs.splice(index, 1); saveData(); renderRoutineManager(); renderDashboard(); } }
         }

        // --- Custom CSS Handling --- (Keep enhanced version)
         function applyCustomCSS(cssText, save = false) { /* ... keep enhanced version ... */
             const id = 'custom-user-styles'; let styleElement = document.getElementById(id); if (styleElement) { styleElement.remove(); } if (!cssText) { if (save) localStorage.removeItem(LOCAL_STORAGE_CSS_KEY); cssImportStatusEl.textContent = '自定义样式已移除。'; cssImportStatusEl.className = 'success'; setTimeout(()=>{ cssImportStatusEl.textContent = ''; cssImportStatusEl.className = ''; }, 3000); return; } styleElement = document.createElement('style'); styleElement.id = id; styleElement.type = 'text/css'; styleElement.textContent = cssText; document.head.appendChild(styleElement); const statusEl = cssImportStatusEl; if (save) { try { localStorage.setItem(LOCAL_STORAGE_CSS_KEY, cssText); statusEl.textContent = '样式已应用并保存。'; statusEl.className = 'success'; } catch (e) { console.error("Error saving CSS:", e); statusEl.textContent = '样式已应用，保存失败。'; statusEl.className = 'error'; } } else { statusEl.textContent = '已加载保存样式。'; statusEl.className = 'success'; } setTimeout(()=>{ statusEl.textContent = ''; statusEl.className = ''; }, 3000);
         }
         function removeCustomCSS() { applyCustomCSS(null, true); }
         function loadCustomCSS() { /* ... keep enhanced version ... */
             const statusEl = cssImportStatusEl; try { const css = localStorage.getItem(LOCAL_STORAGE_CSS_KEY); if (css) { applyCustomCSS(css, false); } } catch (e) { console.error("Error loading CSS:", e); statusEl.textContent = '加载样式出错。'; statusEl.className = 'error'; setTimeout(()=>{ statusEl.textContent = ''; statusEl.className = ''; }, 3000); }
         }

        // --- Event Listeners Setup --- (Keep enhanced version)
        debuffIntensitySlider.addEventListener('input', (e) => { intensityValueDisplay.textContent = e.target.value; });
        submitDebuffBtn.addEventListener('click', submitDebuff);
        routineListEl.addEventListener('click', (event) => { const button = event.target.closest('.routine-done-btn'); if (button) { const routineName = button.dataset.routineName; if (!routineName) return; const routineIndex = appData.routine_configs.findIndex(r => r.name === routineName); if (routineIndex > -1) { appData.routine_configs[routineIndex].last_completed = new Date().toISOString(); addLogEntry({ type: 'routine_completed', routine_name: routineName }); } else { console.warn(`Routine "${routineName}" not found.`); } } });
        exportBtn.addEventListener('click', () => { /* ... keep enhanced version ... */ try { const dataStr = JSON.stringify(appData, null, 2); const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-'); link.href = url; link.download = `hangxu-ai-data-${timestamp}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); importStatusEl.textContent = '数据已导出。'; importStatusEl.className = 'success'; } catch (e) { console.error("Export failed:", e); importStatusEl.textContent = '数据导出失败。'; importStatusEl.className = 'error'; } setTimeout(()=>{ importStatusEl.textContent = ''; importStatusEl.className = ''; }, 3000); });
        importFileInput.addEventListener('change', (event) => { /* ... keep enhanced version ... */ const file = event.target.files[0]; if (!file || !file.name.toLowerCase().endsWith('.json')) { event.target.value = null; return; } const reader = new FileReader(); importStatusEl.textContent = '读取文件中...'; importStatusEl.className = ''; reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (importedData && typeof importedData === 'object' && Array.isArray(importedData.logEntries) && Array.isArray(importedData.routine_configs) && typeof importedData.customDebuffCategories === 'object' && importedData.customDebuffCategories !== null) { if (confirm("导入数据将覆盖当前所有内容，确定继续吗？")) { appData = importedData; ensureAllDefaultRoutinesExist(false); saveData(); renderUI(); importStatusEl.textContent = '数据导入成功！'; importStatusEl.className = 'success'; } else { importStatusEl.textContent = '导入已取消。'; importStatusEl.className = ''; } } else { throw new Error("文件内容格式无效或不完整。"); } } catch (err) { console.error("Import failed:", err); importStatusEl.textContent = `导入失败: ${err.message}`; importStatusEl.className = 'error'; } finally { event.target.value = null; setTimeout(()=>{ importStatusEl.textContent = ''; importStatusEl.className = ''; }, 4000); } }; reader.onerror = () => { importStatusEl.textContent = '读取文件时出错。'; importStatusEl.className = 'error'; event.target.value = null; setTimeout(()=>{ importStatusEl.textContent = ''; importStatusEl.className = ''; }, 4000); }; reader.readAsText(file); });
        importCssInput.addEventListener('change', (event) => { /* ... keep enhanced version ... */ const file = event.target.files[0]; if (!file || !file.name.toLowerCase().endsWith('.css')) { event.target.value = null; return; } const reader = new FileReader(); cssImportStatusEl.textContent = '读取样式...'; cssImportStatusEl.className = ''; reader.onload = (e) => { applyCustomCSS(e.target.result, true); }; reader.onerror = () => { cssImportStatusEl.textContent = '读取 CSS 文件出错。'; cssImportStatusEl.className = 'error'; setTimeout(()=>{ cssImportStatusEl.textContent = ''; cssImportStatusEl.className = ''; }, 4000); }; reader.readAsText(file); event.target.value = null; });
        removeCssBtn.addEventListener('click', removeCustomCSS);


        // --- Initial Load ---
        loadData(); // Load data from storage OR sample data
        loadCustomCSS();
        renderUI(); // Render everything

        console.log("航·序AI Demo Initialized with data."); // Updated log

        // --- END JS ---
    });
</script>
</body>
</html>
